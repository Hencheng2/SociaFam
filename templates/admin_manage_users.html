{% extends 'base.html' %}

{% block title %}Admin - Manage Users{% endblock %}

{% block content %}
<style>
    @charset "utf-8";

    .fixed-panel-container { position: fixed; left: 0px; width: 100%; background-color: var(--background-color); box-shadow: none; border: none; box-sizing: border-box; display: flex; flex-direction: column; padding: 0px 20px; }

    .users-container { top: 70px; height: calc(-35px + 50vh); border-bottom: 1px solid var(--card-border); z-index: 999; }

    .members-container { bottom: 0px; height: calc(-35px + 50vh); border-top: 1px solid var(--card-border); z-index: 998; }

    .panel-header { flex-shrink: 0; padding: 15px 0px 10px; background-color: var(--background-color); border-bottom: 1px solid var(--card-border); box-sizing: border-box; }

    .panel-content-scrollable { flex-grow: 1; overflow-y: auto; padding-bottom: 20px; position: relative; }

    .fixed-panel-container h1 { font-size: 1.6em; margin-bottom: 8px; }

    .fixed-panel-container h3 { font-size: 1.1em; margin-bottom: 0px; }

    .table { color: var(--text-color); margin-bottom: 0px; width: 100%; table-layout: auto; }

    .table th { background-color: var(--header-bg); color: var(--header-text); position: sticky; top: 0px; z-index: 10; font-size: 0.75em; padding: 8px; text-align: left; }

    .table td { vertical-align: middle; font-size: 0.7em; padding: 8px; }

    .table-hover tbody tr:hover { background-color: var(--hover-bg); }

    .card { background-color: transparent; border: none; box-shadow: none; margin-bottom: 0px; }

    .alert-container { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; z-index: 1050; text-align: center; padding-top: 10px; }

    .alert { margin-bottom: 10px; }

    .modal.fade.show { overflow: hidden auto; z-index: 99999 !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: fixed !important; top: 0px !important; left: 0px !important; width: 100vw !important; height: 100vh !important; transform: none !important; }

    .modal-backdrop.fade.show { z-index: 99998 !important; opacity: 0.5 !important; position: fixed !important; }

    .modal-dialog { z-index: 99999 !important; position: relative !important; transform: none !important; }

    .modal-content { z-index: 99999 !important; position: relative !important; }

    .in-page-overlay { position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0, 0, 0, 0.6); z-index: 100; visibility: hidden; opacity: 0; transition: opacity 0.3s, visibility 0.3s; }

    .in-page-overlay.show { visibility: visible; opacity: 1; }

    .in-page-overlay .modal-content { position: relative; z-index: 101; background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--card-border); border-radius: 0.5rem; box-shadow: rgba(0, 0, 0, 0.15) 0px 0.5rem 1rem; max-width: 500px; width: 90%; margin: auto; }

    .table .btn { font-size: 0.7em; padding: 4px 8px; white-space: nowrap; }

    @media (min-width: 768px) {
    .fixed-panel-container { padding: 0px 30px; }
    .panel-header { padding: 20px 0px 10px; }
    .panel-content-scrollable { padding-bottom: 30px; }
    .fixed-panel-container h1 { font-size: 1.6em; margin-bottom: 8px; }
    .fixed-panel-container h3 { font-size: 1.1em; margin-bottom: 0px; }
    .table th { font-size: 0.85em; }
    .table td { font-size: 0.8em; }
    .table .btn { font-size: 0.75em; padding: 5px 10px; }
    }
</style>

{# Users Container (Top Half) #}
<div class="fixed-panel-container users-container" id="usersContainer">
    <div class="panel-header">
        <h1 class="text-center">Admin Panel - Manage Users</h1>
        <h3 class="card-title">Registered Users</h3>
    </div>
    <div class="panel-content-scrollable">
        <div class="card">
            {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Original Name</th>
                                <th>Unique Key</th>
                                <th>P/W Reset</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                                {# Exclude admin users and AdminAI from this list #}
                                {% if not user.is_admin and user.username != 'AdminAI' %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td>{{ user.username }}</td>
                                        <td>{{ user.originalName }}</td>
                                        <td>{{ user.unique_key }}</td>
                                        <td>
                                            {% if user.password_reset_pending == 1 %}
                                                <span class="badge bg-warning text-dark">Pending</span>
                                                <span class="badge bg-info ms-1" data-bs-toggle="tooltip" title="Expires: {{ moment(user.reset_request_timestamp).add(60, 'minutes').calendar() }}">Expires</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column flex-md-row gap-1">
                                                {# Initiate Password Reset Request #}
                                                {% if user.password_reset_pending == 0 %}
                                                    <form action="{{ url_for('admin_manage_users') }}" method="POST" style="display:inline;">
                                                        <input type="hidden" name="action" value="initiate_password_reset">
                                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                                        <button type="submit" class="btn btn-sm btn-warning">Initiate Reset</button>
                                                    </form>
                                                {% else %}
                                                    <button type="button" class="btn btn-sm btn-success" disabled="">Reset Initiated</button>
                                                {% endif %}

                                                {# Delete User Account #}
                                                <form action="{{ url_for('admin_manage_users') }}" method="POST" style="display:inline;">
                                                    <input type="hidden" name="action" value="delete_user">
                                                    <input type="hidden" name="user_id" value="{{ user.id }}">
                                                    <button type="submit" class="btn btn-sm btn-danger" {% if user.id == current_user.id %}disabled="" title="Cannot delete your own account"{% endif %}>Delete</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center text-muted mt-3">No registered users found.</p>
            {% endif %}
        </div>
    </div>
</div>

{# Flash Messages Container - adjusted position #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message | safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{# Members Container (Bottom Half) #}
<div class="fixed-panel-container members-container" id="membersContainer">
    <div class="panel-header">
        <h3 class="card-title">Member Profiles (Family Tree)</h3>
    </div>
    <div class="panel-content-scrollable">
        <div class="card">
            {% if members_with_status %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Linked User</th>
                                <th>Messaging Enabled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in members_with_status %}
                                <tr>
                                    <td>{{ member.id }}</td>
                                    <td>{{ member.fullName }}</td>
                                    <td>
                                        {% if member.username %}
                                            {{ member.username }}
                                            {% if member.user_id == current_user.id %}<span class="badge bg-primary ms-1">You</span>{% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if member.user_id %}
                                            <form action="{{ url_for('admin_manage_users') }}" method="POST" style="display:inline;">
                                                <input type="hidden" name="action" value="toggle_login_access">
                                                <input type="hidden" name="member_id" value="{{ member.id }}">
                                                <button type="submit" class="btn btn-sm {% if member.can_message %}btn-success{% else %}btn-secondary{% endif %}">
                                                    {% if member.can_message %}Enabled{% else %}Disabled{% endif %}
                                                </button>
                                            </form>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column flex-md-row gap-1">
                                            <a href="{{ url_for('member_detail', member_id=member.id) }}" class="btn btn-sm btn-info">View</a>
                                            <a href="{{ url_for('edit_member', member_id=member.id) }}" class="btn btn-sm btn-warning">Edit</a>
                                            <form action="{{ url_for('delete_member', member_id=member.id) }}" method="POST" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                            </form>
                                            {# View Status Button #}
                                            {% if member.status_file_path %}
                                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#adminShowStatusModal" data-member-name="{{ member.fullName }}" data-file-path="{{ member.status_file_path }}" data-is-video="{{ member.status_is_video }}" data-expires-at="{{ moment(member.status_expires_at).calendar() }}" data-status-id="{{ member.status_id }}" data-status-owner="{{ member.fullName }}">
                                                    View Status
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-secondary" disabled="">No Status</button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-center text-muted mt-3">No member profiles found.</p>
            {% endif %}
        </div>
    </div>
</div>

{# Admin Show Status Modal - moved outside panels for proper modal behavior #}
<div class="modal fade" id="adminShowStatusModal" tabindex="-1" aria-labelledby="adminShowStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="adminShowStatusModalLabel">Status for <span id="statusMemberNameSpan"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="statusMediaContainer" class="text-center">
                    <p id="statusLoadingMessage">Loading status...</p>
                    <video id="statusVideoPlayer" controls="" class="img-fluid rounded shadow-sm" style="max-height: 500px; display: none;"></video>
                    <img id="statusImagePlayer" class="img-fluid rounded shadow-sm" style="max-height: 500px; display: none;">
                    <p id="statusMediaMessage" class="mt-2 text-muted"></p>
                    <p id="statusMediaExpires" class="text-muted small"></p>
                </div>
            </div>
            <div class="modal-footer">
                <form id="adminDeleteStatusForm" action="#" method="POST" style="display:inline;"> {# Changed action to # to prevent Jinja2 build error #}
                    {# The form action will be set by JS when the modal is shown #}
                    <button type="submit" class="btn btn-danger">Delete Status</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide flash messages
        const flashMessages = document.querySelectorAll('.alert-container .alert');
        flashMessages.forEach(function(flash) {
            setTimeout(function() {
                flash.style.opacity = '0';
                flash.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    flash.remove();
                }, 500);
            }, 5000);
        });

        // JavaScript for handling the Admin Show Status Modal
        const adminShowStatusModal = document.getElementById('adminShowStatusModal');
        if (adminShowStatusModal) {
            adminShowStatusModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Button that triggered the modal
                const memberName = button.getAttribute('data-member-name');
                const filePath = button.getAttribute('data-file-path');
                const isVideo = button.getAttribute('data-is-video') === 'True' || button.getAttribute('data-is-video') === '1';
                const expiresAt = button.getAttribute('data-expires-at');
                const statusId = button.getAttribute('data-status-id');

                // Get modal elements
                const statusMemberNameSpan = adminShowStatusModal.querySelector('#statusMemberNameSpan');
                const statusLoadingMessage = adminShowStatusModal.querySelector('#statusLoadingMessage');
                const statusVideoPlayer = adminShowStatusModal.querySelector('#statusVideoPlayer');
                const statusImagePlayer = adminShowStatusModal.querySelector('#statusImagePlayer');
                const statusMediaExpires = adminShowStatusModal.querySelector('#statusMediaExpires');
                const adminDeleteStatusForm = document.getElementById('adminDeleteStatusForm');

                // Reset modal content
                statusLoadingMessage.style.display = 'block';
                statusVideoPlayer.style.display = 'none';
                statusImagePlayer.style.display = 'none';
                statusVideoPlayer.src = '';
                statusImagePlayer.src = '';
                statusMemberNameSpan.textContent = memberName || 'Member';
                statusMediaExpires.textContent = `Expires: ${expiresAt}`;

                // Set the action for the delete form dynamically - THIS IS THE CHANGE
                // It now directly constructs the URL using JavaScript template literals
                adminDeleteStatusForm.action = `/admin/delete_status_by_admin/${statusId}`;


                // Load media
                if (filePath) {
                    if (isVideo) {
                        statusVideoPlayer.src = filePath;
                        statusVideoPlayer.style.display = 'block';
                        statusVideoPlayer.load(); // Load the video
                    } else {
                        statusImagePlayer.src = filePath;
                        statusImagePlayer.style.display = 'block';
                    }
                    statusLoadingMessage.style.display = 'none';
                } else {
                    statusLoadingMessage.textContent = "No media available.";
                }
            });

            // Pause video when modal is hidden
            adminShowStatusModal.addEventListener('hidden.bs.modal', function () {
                const statusVideoPlayer = adminShowStatusModal.querySelector('#statusVideoPlayer');
                if (statusVideoPlayer) {
                    statusVideoPlayer.pause();
                    statusVideoPlayer.currentTime = 0; // Reset video to start
                }
            });
        }
    });
</script>
{% endblock %}
