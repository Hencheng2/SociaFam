{% extends 'base.html' %}

{% block title %}Status Feed{% endblock %}

{% block content %}


{# Fixed Top Container: Page Title #}


{# Alerts will be positioned fixed, so they don't need to be in a container #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message | safe }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{# Scrollable Content Container #}
<div class="scrollable-content-container" id="scrollableContentContainer">
    <div class="status-feed-inner-content">
        {% if statuses %}
            {% for status in statuses %}
            <div class="status-item">
                <div class="status-thumbnail-wrapper" data-video-src="{{ url_for('uploaded_video', filename=status.file_path) if status.is_video else url_for('uploaded_file', filename=status.file_path) }}" data-status-index="{{ loop.index0 }}">
                    {% if status.profilePhoto %}
                        <img src="{{ url_for('uploaded_file', filename=status.profilePhoto) }}" alt="{{ status.fullName }} Profile" class="status-thumbnail">
                    {% else %}
                        <img src="{{ url_for('static', filename='img/default_profile.png') }}" alt="Default Profile" class="status-thumbnail">
                    {% endif %}
                </div>
                <div class="status-info">
                    <h5>{{ status.fullName }}</h5>
                    <p>Posted: {{ moment(status.upload_time).fromNow() }}</p>
                    <p>Expires: {{ moment(status.expires_at).calendar() }}</p>
                </div>
                {# Delete Button for Status - Visible to Admin OR the Uploader #}
                {% if current_user.is_admin or (status.uploader_user_id and current_user.id == status.uploader_user_id) %}
                    <div class="status-delete-btn-container">
                        <form action="{{ url_for('delete_status_by_admin', status_id=status.id) if current_user.is_admin else url_for('delete_status', member_id=status.member_id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </div>
                {% endif %}
                {# Download Button for Status #}
                {% if status.file_path %}
                    <a href="{{ url_for('uploaded_video', filename=status.file_path) if status.is_video else url_for('uploaded_file', filename=status.file_path) }}" download class="status-download-btn" title="Download Status">
                        <i class="fas fa-download"></i>
                    </a>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p class="text-center text-muted">No active family statuses right now. Check back later!</p>
        {% endif %}
    </div>
</div>

{# Floating Upload Video Status Button #}
<div class="floating-upload-button-container">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadVideoModal">
        <i class="fas fa-plus-circle me-2"></i> Upload Video Status
    </button>
</div>

{# Fullscreen Video Modal #}
<div class="modal fade fullscreen-video-modal" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen"> {# Use modal-fullscreen for full screen #}
        <div class="modal-content">
            {# Removed modal-header and its btn-close #}
            <div class="modal-body">
                <video id="statusVideoPlayer" autoplay="" playsinline=""> {# Removed 'controls' attribute #}
                    Your browser does not support the video tag.
                </video>
                <div class="status-progress-container">
                    <div class="status-progress-bar" id="statusProgressBar"></div>
                </div>
                <i id="playPauseIcon" class="play-pause-icon-overlay fas"></i>
            </div>
        </div>
    </div>
</div>

{# Video Upload Modal (Moved from my_profile.html) #}
<div class="modal fade" id="uploadVideoModal" tabindex="-1" aria-labelledby="uploadVideoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadVideoModalLabel">Upload Video Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            {# PROBLEM LINE IS HERE - CHANGED ACTION #}
            <form id="videoUploadForm" action="{{ url_for('upload_status') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="video_file" class="form-label">Select Video File</label>
                        <input class="form-control" type="file" id="video_file" name="status_file" accept="video/*,image/*" required=""> {# Changed name to status_file, added image accept #}
                        <small class="form-text text-muted">Max file size 5MB. Supported formats: MP4, MOV, AVI, WEBM, JPG, PNG, GIF.</small> {# Updated message #}
                    </div>
                    <div id="videoUploadMessage" class="mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadVideoBtn">Upload Status</button> {# Updated button text #}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('statusVideoPlayer');
        const statusProgressBar = document.getElementById('statusProgressBar');
        const playPauseIcon = document.getElementById('playPauseIcon');

        let currentPlayingVideoElement = null; // To track the currently playing video in the modal
        let progressInterval = null; // For updating the progress bar

        videoModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            const videoSrc = button.dataset.videoSrc; // Extract info from data-* attributes
            const statusIndex = button.dataset.statusIndex;

            if (videoSrc) {
                // Determine if it's a video or image. Check file extension or a data attribute.
                // For simplicity, let's assume if it ends with video extensions, it's a video.
                const isVideo = videoSrc.match(/\.(mp4|mov|avi|wmv|flv)$/i);

                if (isVideo) {
                    videoPlayer.style.display = 'block'; // Show video element
                    videoPlayer.src = videoSrc;
                    videoPlayer.load();
                    videoPlayer.play();
                    currentPlayingVideoElement = videoPlayer; // Set current playing element
                    playPauseIcon.classList.remove('fa-play', 'fa-pause'); // Clear icons
                    playPauseIcon.classList.add('fa-pause'); // Show pause initially
                    playPauseIcon.classList.remove('show'); // Hide overlay initially

                    // Reset progress bar
                    statusProgressBar.style.width = '0%';
                    clearInterval(progressInterval); // Clear any existing interval

                    // Start progress bar update
                    progressInterval = setInterval(updateProgressBar, 100);

                } else {
                    // It's an image status, display it as an image within the modal
                    // You would typically replace the video element with an image element
                    // or dynamically change the content of the modal-body.
                    // For this example, we will just hide the video and show an image.
                    videoPlayer.style.display = 'none'; // Hide video element
                    // You'd need an <img> tag in your modal-body to show the image here
                    // For now, let's just make sure the video player is hidden.
                    console.warn("Status is an image, video player is hidden. Implement image display for modal.");
                }
            }
        });

        videoModal.addEventListener('hidden.bs.modal', function () {
            if (currentPlayingVideoElement) {
                currentPlayingVideoElement.pause();
                currentPlayingVideoElement.src = ''; // Clear source to stop download
                currentPlayingVideoElement.load();
                currentPlayingVideoElement = null;
            }
            clearInterval(progressInterval); // Stop updating progress bar
            statusProgressBar.style.width = '0%'; // Reset progress bar
            playPauseIcon.classList.remove('show'); // Hide icon overlay
        });

        // Toggle play/pause on video click
        videoPlayer.addEventListener('click', function () {
            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
        });

        // Show/hide play/pause icon on video state change
        videoPlayer.addEventListener('play', function() {
            playPauseIcon.classList.remove('fa-play');
            playPauseIcon.classList.add('fa-pause');
            playPauseIcon.classList.remove('show'); // Hide when playing
        });

        videoPlayer.addEventListener('pause', function() {
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            playPauseIcon.classList.add('show'); // Show when paused
        });

        videoPlayer.addEventListener('ended', function() {
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            playPauseIcon.classList.add('show'); // Show play icon when ended
            clearInterval(progressInterval); // Stop progress bar
            statusProgressBar.style.width = '100%'; // Ensure full
        });

        // Progress Bar Update Function
        function updateProgressBar() {
            if (videoPlayer.duration) {
                const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                statusProgressBar.style.width = `${progress}%`;
            }
        }

        // Handle full screen on video click for mobile
        videoPlayer.addEventListener('touchstart', function() {
            if (videoPlayer.requestFullscreen) {
                videoPlayer.requestFullscreen();
            } else if (videoPlayer.webkitRequestFullscreen) { /* Safari */
                videoPlayer.webkitRequestFullscreen();
            } else if (videoPlayer.msRequestFullscreen) { /* IE11 */
                videoPlayer.msRequestFullscreen();
            }
        });

        // Handle file upload form submission
        const videoUploadForm = document.getElementById('videoUploadForm');
        const uploadVideoMessage = document.getElementById('videoUploadMessage');

        if (videoUploadForm) {
            videoUploadForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevent default form submission

                const formData = new FormData(this);
                const uploadButton = document.getElementById('uploadVideoBtn');
                uploadButton.disabled = true;
                uploadVideoMessage.style.display = 'block';
                uploadVideoMessage.className = 'mt-3 text-info';
                uploadVideoMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Uploading...';

                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        uploadVideoMessage.className = 'mt-3 text-success';
                        uploadVideoMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i> ' + result.message;
                        // Optionally close modal after successful upload
                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadVideoModal'));
                            modal.hide();
                            location.reload(); // Reload page to show new status
                        }, 1500);
                    } else {
                        uploadVideoMessage.className = 'mt-3 text-danger';
                        uploadVideoMessage.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> ' + (result.error || 'Upload failed.');
                    }
                } catch (error) {
                    uploadVideoMessage.className = 'mt-3 text-danger';
                    uploadVideoMessage.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> An error occurred: ' + error.message;
                } finally {
                    uploadButton.disabled = false;
                }
            });
        }
    });
</script>


{% endblock %}

{% block footer %}{% endblock %}
