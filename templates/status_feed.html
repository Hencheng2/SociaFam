{% extends "base.html" %}

{% block title %}Status Feed{% endblock %}

{% block content %}
<style>
    .alert-container {
        position: fixed;
        top: 80px; /* Below navbar and fixed title */
        right: 20px;
        z-index: 1050;
        max-width: 400px;
    }
    .video-container {
        max-width: 320px;
        margin: 0 auto;
    }
</style>

<!-- Fixed Top Title -->
<div class="container-fluid bg-light py-3 shadow-sm fixed-top" style="top: 56px;">
    <h2 class="text-center">Status Updates</h2>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="alert-container">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message | safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<!-- Status Feed -->
<div class="container mt-4" style="padding-top: 60px;">
    {% if not current_user.is_authenticated %}
        <div class="alert alert-warning text-center" role="alert">
            Please <a href="{{ url_for('login') }}">log in</a> to view the status feed.
        </div>
    {% else %}
        {% if statuses and statuses|length > 0 %}
            {% for status in statuses %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <img src="{% if status.profilePhoto %}{{ url_for('static', filename='img/profile_photos/' + status.profilePhoto) }}{% else %}{{ url_for('static', filename='img/default_profile.png') }}{% endif %}" alt="{{ status.fullName }} Profile Photo" class="img-fluid rounded-circle me-3" style="width: 50px; height: 50px;">
                            <div>
                                <h5 class="mb-0">{{ status.fullName }}</h5>
                                <small>Uploaded: {{ moment(status.upload_time).fromNow() }}</small><br>
                                <small>Expires: {{ moment(status.expires_at).calendar() }}</small>
                            </div>
                        </div>
                        <div class="video-container">
                            <video width="320" height="240" data-bs-toggle="modal" data-bs-target="#videoModal" data-video-src="{{ url_for('static', filename=status.file_path) }}" preload="metadata">
                                <source src="{{ url_for('static', filename=status.file_path) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="d-flex justify-content-end mt-2 gap-2">
                            <a href="{{ url_for('download_status', status_id=status.id) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-download"></i> Download
                            </a>
                            {% if current_user.is_admin or current_user.id == status.uploader_user_id %}
                                <form method="POST" action="{{ url_for('delete_status', status_id=status.id) }}">
                                    {{ form.hidden_tag() }}
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this status?');">Delete</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center text-muted">No active family statuses right now. Check back later!</p>
        {% endif %}

        <!-- Floating Upload Button -->
        <a href="#" class="btn btn-primary btn-lg rounded-circle shadow" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; line-height: 60px; font-size: 1.5rem; text-align: center;" data-bs-toggle="modal" data-bs-target="#uploadVideoModal">
            <i class="fas fa-plus"></i>
        </a>
    {% endif %}
</div>

<!-- Fullscreen Video Modal -->
<div class="modal fade modal-fullscreen" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
    <div class="modal-content">
        <div class="d-flex justify-content-end p-2">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
        <video id="modalVideo" class="w-100 h-100" controls>
            <source src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
</div>

<!-- Video Upload Modal -->
<div class="modal fade" id="uploadVideoModal" tabindex="-1" aria-labelledby="uploadVideoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadVideoModalLabel">Upload Video Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('upload_status') }}" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        <label for="video_file" class="form-label">Video File</label>
                        <input type="file" class="form-control" id="video_file" name="video_file" accept="video/mp4,video/x-m4v,video/avi,video/webm" required aria-describedby="videoHelp">
                        <div id="videoHelp" class="form-text">Max file size 5MB. Supported formats: MP4, MOV, AVI, WEBM.</div>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload Video</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Set video source for fullscreen modal
    document.querySelectorAll('video[data-video-src]').forEach(video => {
        video.addEventListener('click', function() {
            const modalVideo = document.getElementById('modalVideo');
            modalVideo.querySelector('source').src = this.getAttribute('data-video-src');
            modalVideo.load();
            modalVideo.play();
        });
    });

    // Reset modal video source on close to prevent playback issues
    document.getElementById('videoModal').addEventListener('hidden.bs.modal', function() {
        const modalVideo = document.getElementById('modalVideo');
        modalVideo.querySelector('source').src = '';
        modalVideo.load();
    });
</script>
{% endblock %}

{% block footer %}{% endblock %}
