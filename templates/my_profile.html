{% extends "base.html" %}

{% block title %}
    {% if current_user.id == member.user_id %}
        My Profile
    {% else %}
        {{ member.fullName }}'s Profile
    {% endif %}
{% endblock %}

{% block content %}
<style>
    /* Fixed Header Styling */
    .fixed-top.header {
        top: 56px; /* Adjust for main navbar height */
        position: fixed;
        left: 0;
        right: 0;
        background-color: var(--background-color);
        padding: 15px 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 1000;
        border-bottom: 1px solid var(--border-color);
    }
    .profile-photo {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid var(--primary-color);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    /* Scrollable Content Styling */
    .scrollable-content-container {
        padding-top: 220px; /* Space for the fixed header */
        padding-bottom: 20px; /* Padding at the bottom */
        overflow-y: auto; /* Enable scrolling for content */
        height: 100vh; /* Take full viewport height */
        box-sizing: border-box; /* Include padding in height calculation */
        background-color: var(--background-color);
        color: var(--text-color);
    }
    .profile-card {
        background-color: var(--card-background-color);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 20px;
    }
    .profile-card h4 {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }
    .profile-card p {
        margin-bottom: 10px;
        line-height: 1.6;
    }
    .profile-card .list-unstyled li {
        margin-bottom: 8px;
    }
    .profile-card .list-unstyled strong {
        color: var(--secondary-text-color);
        margin-right: 5px;
    }
    .badge-status {
        font-size: 0.85em;
        padding: 0.4em 0.8em;
        border-radius: 0.5rem;
        font-weight: normal;
        margin-left: 10px;
        vertical-align: middle;
    }
    .status-section video {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>

<!-- Fixed Header Container -->
<div class="fixed-top header text-center">
    <img src="{% if member.profilePhoto %}{{ url_for('static', filename='img/profile_photos/' + member.profilePhoto) }}{% else %}{{ url_for('static', filename='img/default_profile.png') }}{% endif %}"
         alt="{{ member.fullName }} Profile Photo"
         class="img-fluid profile-photo mx-auto d-block mb-3">
    <h3 class="mb-0 text-center">{{ member.fullName }}</h3>
    <h4 class="text-muted mb-0 text-center">
        {% if current_user.id == member.user_id %}
            My Profile
        {% else %}
            {{ member.fullName }}'s Profile
        {% endif %}
    </h4>
</div>

<!-- Scrollable Content Container -->
<div class="container scrollable-content-container">
    {% if not current_user.is_authenticated %}
        <div class="alert alert-warning text-center" role="alert">
            Please <a href="{{ url_for('login') }}">log in</a> to view profile details.
        </div>
    {% else %}
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="alert-container mb-4">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message | safe }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Profile Actions -->
        {% if current_user.is_admin or current_user.id == member.user_id %}
        <div class="d-flex justify-content-center gap-2 mb-4">
            {% if current_user.id == member.user_id %}
                <a href="{{ url_for('add_my_details') }}" class="btn btn-primary">Edit My Details</a>
            {% else %}
                <a href="{{ url_for('edit_member', member_id=member.id) }}" class="btn btn-warning">Edit Member</a>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteMemberModal">Delete Member</button>
            {% endif %}
        </div>
        {% endif %}

        <!-- Member Details Section -->
        <div class="profile-card">
            <h4>Basic Information</h4>
            <ul class="list-unstyled">
                <li><strong>Date of Birth:</strong> {{ member.dateOfBirth or 'N/A' }}</li>
                <li><strong>Gender:</strong> {{ member.gender or 'N/A' }}</li>
                <li><strong>Current Whereabouts:</strong> {{ member.whereabouts or 'N/A' }}</li>
                <li><strong>User Account Linked:</strong>
                    {% if member.username %}
                        Yes ({{ member.username }})
                        {% if current_user.id != member.user_id %}
                            {% if member.can_message %}
                                <a href="{{ url_for('chat_messages_direct', recipient_id=member.user_id) }}" class="btn btn-sm btn-info ms-2">Message</a>
                            {% else %}
                                <span class="badge bg-secondary ms-2">Messaging Disabled</span>
                            {% endif %}
                        {% endif %}
                    {% else %}
                        No
                    {% endif %}
                </li>
                {% if current_user.id == member.user_id %} {# Only show unique key for current user's own profile #}
                    <li><strong>Your Unique Key:</strong> <span class="badge bg-secondary">{{ current_user.unique_key }}</span>
                        <small class="text-muted ms-2">Keep this safe! Used for password recovery.</small>
                    </li>
                {% endif %}
            </ul>
        </div>

        <!-- Dynamic Relationship Status -->
        <div class="profile-card">
            <h4>Relationship Status</h4>
            <p>
                {% if member.fullName %}
                    {{ member.fullName }}
                {% else %}
                    This member
                {% endif %}
                {% if member.maritalStatus == 'Married' %}
                    is married.
                    {% if member.gender == 'Male' %}
                        His wife is
                    {% elif member.gender == 'Female' %}
                        Her husband/wife is
                    {% else %}
                        Their spouse is
                    {% endif %}
                    {% if member.spouseNames and member.spouseNames[0].strip() %} {# Check if the list is not empty and the first element is not just whitespace #}
                        {{ member.spouseNames | join(', ') }}.
                    {% else %}
                        (Name not specified).
                    {% endif %}
                {% elif member.maritalStatus == 'Engaged' %}
                    is engaged.
                    {% if member.gender == 'Male' %}
                        His fiancée is
                    {% elif member.gender == 'Female' %}
                        Her fiancé(e) is
                    {% else %}
                        Their fiancé(e) is
                    {% endif %}
                    {% if member.fianceNames and member.fianceNames[0].strip() %} {# Check if the list is not empty and the first element is not just whitespace #}
                        {{ member.fianceNames | join(', ') }}.
                    {% else %}
                        (Name not specified).
                    {% endif %}
                {% elif member.maritalStatus == 'Single' %}
                    is currently single.
                {% elif member.maritalStatus == 'Divorced' %}
                    is divorced.
                {% elif member.maritalStatus == 'Widowed' %}
                    is widowed.
                {% else %}
                    's marital status is not specified.
                {% endif %}
            </p>
        </div>

        <!-- Children Section -->
        {% if member.childrenNames and member.childrenNames[0].strip() %} {# Check if the list is not empty and the first element is not just whitespace #}
        <div class="profile-card">
            <h4>Children</h4>
            <ul class="list-unstyled">
                {% for child in member.childrenNames %}
                    <li>{{ child.strip() }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Education Section -->
        {% if member.educationLevel and member.educationLevel != 'None' %}
        <div class="profile-card">
            <h4>Education</h4>
            <ul class="list-unstyled">
                <li><strong>Level:</strong> {{ member.educationLevel }}</li>
                {% if member.schoolName %}
                    <li><strong>Institution:</strong> {{ member.schoolName }}</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        <!-- Contact Information Section -->
        {% if member.phoneNumber or member.emailContact or member.otherContact %}
        <div class="profile-card">
            <h4>Contact Information</h4>
            <ul class="list-unstyled">
                {% if member.phoneNumber %}<li><strong>Phone:</strong> {{ member.phoneNumber }}</li>{% endif %}
                {% if member.emailContact %}<li><strong>Email:</strong> {{ member.emailContact }}</li>{% endif %}
                {% if member.otherContact %}<li><strong>Other:</strong> {{ member.otherContact }}</li>{% endif %}
            </ul>
        </div>
        {% endif %}

        <!-- Biography Section -->
        {% if member.bio %}
        <div class="profile-card">
            <h4>Biography</h4>
            <p>{{ member.bio }}</p>
        </div>
        {% endif %}

        <!-- Status Section (Videos/Photos) -->
        {% if temp_video %}
        <div class="profile-card status-section">
            <h4>Latest Status <span class="badge bg-success badge-status">Active</span></h4>
            <div class="text-center mb-3">
                {% if temp_video.is_video == 1 %}
                    <video controls class="w-100 rounded" style="max-height: 300px; object-fit: contain;">
                        <source src="/{{ temp_video.file_path }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% else %}
                    <img src="/{{ temp_video.file_path }}" alt="Latest Status Photo" class="w-100 rounded" style="max-height: 300px; object-fit: contain;">
                {% endif %}
                <p class="text-muted mt-2">
                    Uploaded: {{ moment(temp_video.upload_time).fromNow() }}
                    (Expires: {{ moment(temp_video.expires_at).calendar() }})
                </p>
                {% if current_user.id == member.user_id %}
                    <button type="button" class="btn btn-sm btn-danger mt-2" data-bs-toggle="modal" data-bs-target="#deleteStatusModal">Delete Status</button>
                {% endif %}
            </div>
        </div>
        {% elif current_user.id == member.user_id %}
            <div class="profile-card text-center text-muted">
                <p>No active status. <a href="{{ url_for('upload_status') }}">Upload a new status</a></p>
            </div>
        {% endif %}

        <!-- Delete Member Modal (for admins/member's user) -->
        <div class="modal fade" id="deleteMemberModal" tabindex="-1" aria-labelledby="deleteMemberModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteMemberModalLabel">Confirm Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete {{ member.fullName }}'s profile? This action cannot be undone.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form method="POST" action="{{ url_for('delete_member', member_id=member.id) }}">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Status Modal -->
        <div class="modal fade" id="deleteStatusModal" tabindex="-1" aria-labelledby="deleteStatusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteStatusModalLabel">Confirm Status Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete your video status? This action cannot be undone.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form method="POST" action="{{ url_for('delete_status', member_id=member.id) }}">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    // Auto-hide flash messages (copied from base.html for consistency)
    const flashMessages = document.querySelectorAll('.flash');
    flashMessages.forEach(function(flash) {
        setTimeout(function() {
            flash.style.opacity = '0';
            flash.style.transition = 'opacity 0.5s ease-out';
            setTimeout(function() {
                flash.remove();
            }, 500);
        }, 5000);
    });
</script>
{% endblock %}
